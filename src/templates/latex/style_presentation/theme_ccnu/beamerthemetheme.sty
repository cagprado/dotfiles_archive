%%% CCNU BEAMER THEME %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                           %
% HOW TO USE                                                                %
%                                                                           %
% After loading beamer document class with:                                 %
%   \documentclass{beamer}                                                  %
% Just load the theme in your preamble:                                     %
%   \usetheme[options]{ccnu}                                                %
%                                                                           %
% Available options are:                                                    %
% - numbering:  shows slide numbers at the right-bottom corner of slide.    %
% - progress:   shows a nice progressbar under the section titles.          %
% - transition: force a transition slide every new \section{} command. Note %
%               that \section*{} will not have a transition slide (and it   %
%               will not appear on the table of contents.                   %
%                                                                           %
% Commands defined in this theme:                                           %
% - \logoframe              Frame with CCNU logo centered.                  %
% - \titleframe             Title frame.                                    %
% - \tocframe{title}        Table of Contents frame with given title.       %
% - \transitionframe{text}  Transition frame with given text.               %
%                                                                           %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% Defining the preamble
\newif\if@transition
\@transitionfalse
\DeclareOption{transition}{\@transitiontrue}
\newif\if@numbering
\@numberingfalse
\DeclareOption{numbering}{\@numberingtrue}
\newif\if@progressbar
\@progressbarfalse
\DeclareOption{progress}{\@progressbartrue}
\ProcessOptions

%%% Some useful commands

%  If you want to stop counting frames after \appendix comment this line or
%  add it to your preamble (between \makeatletter and \makeatother commands).
%  This should work with other templates that rely on the number of frames:
\g@addto@macro\appendix{\edef\realtotalframenumber{\the\c@framenumber}\AtEndDocument{\immediate\write\@auxout{\string\@writefile{nav}{\noexpand\headcommand{\noexpand\def\noexpand\inserttotalframenumber{\realtotalframenumber}}}}}}

% Remove numbers from frames:
%  \nonumbering{\frame{...}} or \nonumbering{\begin{frame}...\end{frame}}
\newcommand\nonumbering[1]{\if@numbering\@numberingfalse#1\@numberingtrue\else#1\fi}

% Adds a transition frame called “Backup” and resets sections after \appendix
\g@addto@macro{\appendix}{
  \@numberingfalse
  \section*{}
  \subsection*{Backup}
  \transitionframe{Backup}
}

%%% CCNU Theme
\mode<all> {
  \usepackage{calc}

  % Font theme %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \usefonttheme{professionalfonts}
  \newfontfamily\upnum{LinBiolinum_}[
    Extension = .otf,
    UprightFont = *R,
    BoldFont = *RB,
    ItalicFont = *RI,
    BoldItalicFont = *RBO,
    Numbers = {Proportional,Lining},
    SmallCapsFeatures = { LetterSpace=5, Kerning=On },
  ]

  \setbeamerfont{title}{series=\bfseries,size=\huge}
  \setbeamerfont{subtitle}{series=\bfseries,size=\Large}
  \setbeamerfont{author}{size=\normalsize}
  \setbeamerfont{institute}{size=\small}
  \setbeamerfont{date}{size=\tiny}
  \setbeamerfont{headline section}{series=\bfseries,size=\tiny}
  \setbeamerfont{headline subsection}{series=\bfseries,size=\Large}
  \setbeamerfont{footline}{size=\tiny}

  \setbeamerfont{frametitle}{series=\bfseries}
  \setbeamerfont{block title}{series=\bfseries}
  \setbeamerfont{item projected}{family=\upnum,series=\bfseries}

  % Color theme %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  % CCNU colors
  \definecolor{00}{HTML}{FFFFFF} % white
  \definecolor{01}{HTML}{4D4D4D} % gray
  \definecolor{02}{HTML}{005768} % blue
  \definecolor{A0}{HTML}{202020} % black/dark gray
  \definecolor{A1}{HTML}{262626}
  \definecolor{A2}{HTML}{393939}
  \definecolor{B0}{HTML}{003039} % blue
  \definecolor{B1}{HTML}{00404C}
  \definecolor{B2}{HTML}{004856}
  \definecolor{C0}{HTML}{DC493A} % sand
  \definecolor{C1}{HTML}{E88B81}
  \definecolor{C2}{HTML}{F5CDC9}
  \definecolor{D0}{HTML}{8C8C8C} % light gray
  \definecolor{D1}{HTML}{BABABA}
  \definecolor{D2}{HTML}{E8E8E8}

  % titlepage
  \setbeamercolor{title}{fg = 00, bg = 02}

  % body
  \setbeamercolor{normal text}{fg = 01, bg = 00}
  \setbeamercolor{background}{fg = 02, bg = 00}

  % table of contents
  \setbeamercolor{section in toc}{fg=02}
  \setbeamercolor{subsection in toc}{fg=B1}
  \setbeamercolor{subsubsection in toc}{fg=A2}

  % header/footer
  \setbeamercolor{headline}{fg = 00, bg = 02}
  \setbeamercolor{footline}{fg = D2, bg = A0}
  \setbeamercolor{frametitle}{fg=00,bg=02}

  % blocks
  \setbeamercolor{block title}{fg = 00, bg = 02}
  \setbeamercolor{block body}{fg = 01, bg = D2}
  \setbeamercolor{block title alerted}{fg = D2, bg = B0}
  \setbeamercolor{block body alerted}{fg = 00, bg = 02}
  \setbeamercolor{block title example}{fg = 00, bg = 02}
  \setbeamercolor{block body example}{fg = 01, bg = C1}

  % lists
  \setbeamercolor{item}{fg = 02}
  \setbeamercolor{subitem}{fg = B1}
  \setbeamercolor{subsubitem}{fg = A2}
  \setbeamercolor{item projected}{bg = 02}
  \setbeamercolor{subitem projected}{bg = B1}
  \setbeamercolor{subsubitem projected}{bg = A2}
  \setbeamercolor{enumerate item}{fg = 02}
  \setbeamercolor{enumerate subitem}{fg = B1}
  \setbeamercolor{enumerate subsubitem}{fg = A2}
  \setbeamercolor{description item}{fg = 02}

  % Inner theme %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  \usepackage{wasysym}
  \setbeamertemplate{itemize items}{\raisebox{1.3pt}{\scriptsize\CIRCLE}}
  \setbeamertemplate{enumerate items}[circle]
  \setbeamertemplate{blocks}[rounded][shadow=true]

  % Outer theme %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  % Navigation symbols
  \setbeamertemplate{navigation symbols}{}

  % Background
  \setbeamertemplate{background}{}
  \setbeamertemplate{background canvas}{\usebeamercolor[bg]{background}\rule{\paperwidth}{\paperheight}}

  % Logo frame
  \newcommand\logoframe{{%
    \setbeamertemplate{footline}{}
    \setbeamertemplate{headline}{\parbox[t][\headheight][t]{\textwidth}{}}
    \setbeamertemplate{background}{\usebeamercolor[fg]{background}\rule{\paperwidth}{\paperheight}}
    \frame[noframenumbering]{\centering\includegraphics[height=\textheight-\headheight+\footheight]{ccnu_logo}}
  }}

  % Title page template
  \setbeamertemplate{title page}{%
    \parbox[b][.43\paperheight-\headheight][b]{\textwidth}{\raggedright\usebeamerfont*{title}\usebeamercolor[fg]{title}\inserttitle}
    \vfill
    \parbox[t][.43\paperheight-\footheight][b]{\textwidth}{%
      \centering\usebeamercolor[fg]{normal text}
      \usebeamerfont*{subtitle}\insertsubtitle
      \vfill
      \vfill
      \usebeamerfont*{author}\insertauthor
      \vfill
      \usebeamerfont*{institute}\insertinstitute
      \vfill
      \vfill
      \usebeamerfont*{date}\insertdate
    }
  }

  % Title frame
  \newcommand\titleframe{{%
    \setbeamertemplate{footline}{}
    \setbeamertemplate{headline}{
    \vspace*{-2ex}
    \begin{center}
        \includegraphics[height=\headheight]{ccnu_full_logo}
        \\\vspace*{-1pt}
        \textcolor{white}{\bfseries\tiny Institute of Particle Physics}
    \end{center}
    }
    \setbeamertemplate{background}{\usebeamercolor[fg]{background}\rule{\paperwidth}{.5\paperheight}}
    \frame[t,noframenumbering]{\titlepage}
  }}

  % Transition frame
  \newcommand\transitionframe[1]{{%
    \setbeamertemplate{footline}{}
    \setbeamertemplate{headline}{\parbox[t][\headheight][t]{\textwidth}{}}
    \setbeamertemplate{background}{\usebeamercolor[fg]{background}\rule{\paperwidth}{.5\paperheight}}
    \frame[t,noframenumbering]{\parbox[b][.43\paperheight-\headheight][b]{\textwidth}{\raggedright\usebeamerfont*{title}\usebeamercolor[fg]{title}#1}}
  }}
  \if@transition\AtBeginSection[]{\transitionframe{\insertsectionhead}}\fi

  % Summary frame
  \newcommand\tocframe[1]{{%
    \section*{}
    \subsection*{#1}
    \nonumbering{\frame[noframenumbering]{\tableofcontents}}
  }}

  % Headline
  \setbeamertemplate{headline}{%
    \begin{beamercolorbox}[wd=\paperwidth,ht=28pt]{headline}
      \begin{minipage}[b][28pt][t]{0.9\textwidth}
        \vspace*{4pt}
        \begin{minipage}[b][8pt][t]{\textwidth}
          \hspace*{7pt}\usebeamerfont*{headline section}\insertsection
        \end{minipage}

        \begin{minipage}[b][16pt][t]{\textwidth}
          \hspace*{7pt}\usebeamerfont*{headline subsection}\insertsubsection
        \end{minipage}
      \end{minipage}%
      \begin{minipage}[b][28pt][c]{0.1\textwidth}
        \centering\includegraphics[height=24pt]{ccnu_logo}
      \end{minipage}
    \end{beamercolorbox}

    % Progress bar
    \if@progressbar
    \newdimen\barlength
    \barlength=\paperwidth
    \divide\barlength by 100 % workaround overflow if 16:9 aspect is selected
    \ifnum \insertframenumber > \inserttotalframenumber
      \multiply\barlength by \inserttotalframenumber
    \else
      \multiply\barlength by \insertframenumber
    \fi
    \divide\barlength by \inserttotalframenumber
    \multiply\barlength by 100
    \usebeamercolor[fg]{normal text}\rule{\barlength}{2pt}
    \fi
  }

  % Footline
  \setbeamertemplate{footline}{%
    \begin{beamercolorbox}[wd=\paperwidth,ht=2.8ex]{footline}%
      \begin{minipage}[b][][c]{0.2\paperwidth}
        \raggedleft\raisebox{.6ex}{\insertshortauthor}\hspace*{1ex}
      \end{minipage}%
      \begin{minipage}[b][][c]{0.6\paperwidth}
        \centering\raisebox{.6ex}{\insertshorttitle}
      \end{minipage}%
      \begin{minipage}[b][][c]{0.2\paperwidth}
        \raisebox{.6ex}{\insertshortdate}\hfill%
        \if@numbering\raisebox{.6ex}{\insertframenumber\,/\,\inserttotalframenumber}\fi%
        \hspace*{1ex}
      \end{minipage}%
    \end{beamercolorbox}
  }
}
