#!/bin/zsh

autoload +X parse_cmdline help

local DESC="Send mail and check for new mails."
local USAGE="%Busage:%b $0"

local HELP=false
local SUMMARY=false
if ! parse_cmdline 'h|help|long-help>HELP H|short-help|summary>SUMMARY' $@; then
  print -P "$USAGE"
  return 1
fi
help $HELP $SUMMARY $0 $USAGE $DESC && return

# first send whatever needs to be sent
$HOME/bin/msmtp-queue -r

# put everything in place, before deleting
[[ "$(hostname)" == "mredson" ]] && afew -m

# now we delete the tag 'delete'
notmuch search --output=files is:delete | xargs -d'\n' -L 1 rm

# finally sync and get new messages and tags
mbsync -a
notmuch new
afew -tn

pkill -SIGRTMIN+10 i3blocks
