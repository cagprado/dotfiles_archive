#!/bin/zsh

local DESC="Test if physical location is home."
local USAGE="%Busage:%b $0"

if [[ "$1" = "-h" ]]; then
  print -P "$USAGE\n$DESC"
  return
elif [[ "$1" = "-H" ]]; then
  print -P -f "%${LIST_WIDTH}s  %s\n" "%B$0%b" "$DESC"
  return
fi

if [[ -z "$AT_HOME_VALUE" ]]; then
  # Variable not set: try finding its value in an auxiliary file
  if [[ -f "$TMPHOME/AT_HOME_VALUE" ]]; then
    export AT_HOME_VALUE=$(<$TMPHOME/AT_HOME_VALUE)

  # No auxiliary file: try to determine it
  else
    local MREDSONIP=$(dig +short +timeout=1 +tries=1 $MREDSON_ADDR 2>/dev/null)
    [[ "$MREDSONIP" =~ "[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}" ]] || return 1

    local MYIP=$(dig +short +timeout=1 +tries=1 myip.opendns.com @resolver1.opendns.com 2>/dev/null)
    [[ "$MYIP" =~ "[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}" ]] || return 1

    [[ "$MYIP" = "$MREDSONIP" ]] && export AT_HOME_VALUE=true || export AT_HOME_VALUE=false
    mkdir -p $TMPHOME >/dev/null 2>&1
    echo $AT_HOME_VALUE > $TMPHOME/AT_HOME_VALUE
  fi
fi

[[ "$AT_HOME_VALUE" = "true" ]]
